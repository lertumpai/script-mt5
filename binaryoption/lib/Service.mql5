#property copyright "ChatGPT"
#property version   "3.4"
#property strict
#property indicator_chart_window
#property indicator_buffers 0

#include "../Include/Lertumpai/candle_v1.mqh"
#include "../Include/Lertumpai/trigger_mt2.mqh"

// INPUTS
input int StartHour = 7;
input int EndHour = 21;
input int TimeZone = 7;

input ENUM_TIMEFRAMES timeFrame = PERIOD_M1;

int OnInit()
{
	//Initialize the time flag
	signalTime = TimeCurrent();
	if (StringLen(Symbol()) >= 6)
		asset = StringSubstr(Symbol(),0,6);
	else
		asset = Symbol();
   
   return(INIT_SUCCEEDED);
}

//+------------------------------------------------------------------+
//| OnCalculate                                                      |
//+------------------------------------------------------------------+
int OnCalculate(const int rates_total,
                const int prev_calculated,
                const datetime &time[],
                const double &open[],
                const double &high[],
                const double &low[],
                const double &close[],
                const long &tick_volume[],
                const long &volume[],
                const int &spread[])
{

    MqlDateTime t; TimeToStruct(TimeCurrent(), t);
    int localHour = (t.hour + TimeZone) % 24;
    if (localHour < StartHour || localHour >= EndHour) return rates_total;

    int minuteNow = t.min;
    if (minuteNow == LastSignalMinute) return 0; 
    
    int secondNow = t.sec;
    if (secondNow < 1) return 0;

    double score = PredictSignal();
    Print("score: ", score);
    
    if (score == 0) {
       Print("==========");
       return rates_total;
    }
    
    SendMT2Signal(score, GetSystemName());
    LastSignalMinute = minuteNow;
    
    Print("==========");
    return rates_total;
}

void PrintLog(string msg) {
   if (EnableLog) Print(msg);
}

string NowDateTime() {
   datetime now = TimeCurrent();
   now += TimeZone * 3600;
   string timeStr = TimeToString(now, TIME_DATE | TIME_SECONDS);
   return timeStr;
}
